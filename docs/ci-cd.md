# CI/CD pipelines

## Overview

`az-loadenv` can be used in CI/CD pipelines to generate `.env` files for integration testing, deployment preparation, or configuration validation. It supports service principal authentication and explicit subscription targeting — no interactive login required.

## GitHub Actions

### Using azure/login with OIDC (recommended)

```yaml
name: Integration tests

on: [push]

permissions:
  id-token: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install az-loadenv
        run: |
          curl -sL https://github.com/curiousdev/az-loadenv/releases/latest/download/az-loadenv-linux-amd64.tar.gz | tar xz
          sudo mv az-loadenv /usr/local/bin/

      - name: Load environment
        run: az-loadenv --app my-api --rg my-resource-group

      - name: Run tests
        run: npm test
```

### Using a service principal secret

```yaml
      - name: Load environment
        env:
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: az-loadenv --app my-api --rg my-resource-group
```

## Azure DevOps Pipelines

```yaml
trigger:
  - main

pool:
  vmImage: ubuntu-latest

steps:
  - task: AzureCLI@2
    displayName: Load environment
    inputs:
      azureSubscription: 'My Service Connection'
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        curl -sL https://github.com/curiousdev/az-loadenv/releases/latest/download/az-loadenv-linux-amd64.tar.gz | tar xz
        ./az-loadenv --app my-api --rg my-resource-group

  - script: npm test
    displayName: Run tests
```

## Docker

```dockerfile
FROM golang:1.25 AS build
RUN go install github.com/curiousdev/az-loadenv@latest

FROM debian:bookworm-slim
COPY --from=build /go/bin/az-loadenv /usr/local/bin/
```

Or in a multi-stage build where you need settings at build time:

```dockerfile
FROM node:22 AS build
COPY --from=ghcr.io/curiousdev/az-loadenv:latest /az-loadenv /usr/local/bin/
ARG AZURE_CLIENT_ID AZURE_CLIENT_SECRET AZURE_TENANT_ID AZURE_SUBSCRIPTION_ID
RUN az-loadenv --app my-api --rg my-resource-group
RUN npm ci && npm run build
```

## Security considerations

- Never commit `.env` files generated by `az-loadenv` — they contain resolved secrets
- Use OIDC (federated credentials) over client secrets when possible
- Scope service principal permissions to the minimum required: reader on the App Service, secrets user on Key Vault
- In pipelines, prefer injecting environment variables per-step rather than writing to a file that persists across steps
